# ---
# - name: D√©ployer application Docker
#   hosts: localhost
#   # become: true
#   vars:
#     repo_dest_kafka: "/home/mathys/Infra-et-orch-de-donn-es"
#     repo_dest_hadoop: "/home/mathys/Infra-et-orch-de-donn-es/Hadoop"

#   tasks:
#     - name: Build et up Docker Compose Kafka
#       command: docker compose up -d --build
#       args:
#         chdir: "{{ repo_dest_kafka }}"

#     - name: Build et up Docker Compose Hadoop
#       command: docker compose up -d --build
#       args:
#         chdir: "{{ repo_dest_hadoop }}"



---
- name: D√©ploiement complet Big Data
  hosts: localhost
  vars:
    repo_dest_kafka: "/home/mathys/Infra-et-orch-de-donn-es"
    repo_dest_hadoop: "/home/mathys/Infra-et-orch-de-donn-es/Hadoop"

  tasks:
    - name: Ensure external Docker network infra exists
      community.docker.docker_network:
          name: infra-net
          state: present
         
        
    - name: Attendre 2 secondes pour que le r√©seau soit pr√™t
      pause:
        seconds: 2


    - name: üß± D√©marrer stack Kafka
      command: docker compose up -d --build
      args:
        chdir: "{{ repo_dest_kafka }}"

    - name: ‚è≥ Attendre que PostgreSQL soit pr√™t
      shell: |
        until docker exec postgres pg_isready -U postgresuser -d postgresdb; do sleep 2; done
      register: pg_ready
      retries: 10
      delay: 3
      ignore_errors: true

    - name: üåê D√©marrer stack Hadoop
      command: docker compose up -d --build
      args:
        chdir: "{{ repo_dest_hadoop }}"
